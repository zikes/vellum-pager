<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../paper-styles/paper-styles.html">
<link rel="import" href="../iron-a11y-keys/iron-a11y-keys.html">
<link rel="import" href="../iron-icon/iron-icon.html">
<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">

<link rel="import" href="vellum-pager-icons.html">

<!--
A pagination control.

Examples:

    <vellum-pager pages="50"></vellum-pager>

With initial page and distance set:

    <vellum-pager page="5" pages="10" distance="3"></vellum-pager>

@demo demo/index.html
-->
<dom-module id="vellum-pager">
  <style>
    :host {
      display: inline-block;
    }
    ul {
      display: inline-block;
      position: relative;
      border-radius: 4px;
      padding: 0;
      margin: 0;
    }
    li {
      display: inline;
    }
    li.active>a {
      font-weight: 500 !important;
      background: var(--google-grey-100);
    }
    li.buffer>a {
      cursor: default;
    }
    li.buffer+li.buffer {
      display: none;
    }
    li>a, li>paper-icon-button {
      position: relative;
      float: left;
    }
    li>a {
      color: #000;
      padding: 6px 12px;
      margin-left: -1px;
      text-decoration: none;
      @apply(--paper-font-body1);
    }
    li.current > a {
      @apply(--paper-font-body2);
      font-size: 18px !important;
      line-height: 28px !important;
    }
  </style>

  <template>
    <iron-a11y-keys target="{{}}" keys="home end left right pageup pagedown" on-keys-pressed="_setFocus"></iron-a11y-keys>
    <iron-a11y-keys target="{{}}" keys="home" on-keys-pressed="first"></iron-a11y-keys>
    <iron-a11y-keys target="{{}}" keys="end" on-keys-pressed="last"></iron-a11y-keys>
    <iron-a11y-keys target="{{}}" keys="left" on-keys-pressed="prev"></iron-a11y-keys>
    <iron-a11y-keys target="{{}}" keys="right" on-keys-pressed="next"></iron-a11y-keys>
    <iron-a11y-keys target="{{}}" keys="pagedown" on-keys-pressed="skipPrev"></iron-a11y-keys>
    <iron-a11y-keys target="{{}}" keys="pageup" on-keys-pressed="skipNext"></iron-a11y-keys>
    <ul>
      <template is="dom-if" if="{{justArrows}}">
        <li><paper-icon-button icon="vellum-pager-icons:first" on-tap="first" alt="First" id="firstButton"></paper-icon-button></li>
        <li><paper-icon-button icon="chevron-left" on-tap="prev" alt="Previous" id="prevButton"></paper-icon-button></li>
        <template is="dom-if" if="{{showCurrent}}">
          <li class="current">
            <a>
              <template is="dom-if" if="{{showTotal}}">
                <span>{{page}}</span>/<span>{{pages}}</span>
              </template>
              <template is="dom-if" if="{{!showTotal}}">
                <span>{{page}}</span>
              </template>
            </a>
          </li>
        </template>
        <li><paper-icon-button icon="chevron-right" on-tap="next" alt="Next"  id="nextButton"></paper-icon-button></li>
        <li><paper-icon-button icon="vellum-pager-icons:last" on-tap="last" alt="Last" id="lastButton"></paper-icon-button></li>
      </template>
      <template is="dom-if" if="{{!justArrows}}">
        <template is="dom-repeat" items="{{numbers}}">
          <li class$="{{item.classed}}">
            <a href="#" on-tap="_paged">{{item.display}}</a>
          </li>
        </template>
      </template>
    </ul>
  </template>
</dom-module>

<script>

  Polymer({
    is: 'vellum-pager',

    properties: {
      /**
       * The total number of pages.
       */
      pages: {
        value: 1,
        type: Number,
        notify: true,
        reflectToAttribute: true,
        observer: '_updatePages'
      },

      /**
       * The current page.
       */
      page: {
        value: 1,
        type: Number,
        notify: true,
        reflectToAttribute: true,
        observer: '_updatePage'
      },

      /**
       * Number of pages to render on each side of current.
       */
      distance: {
        value: 2,
        type: Number,
        notify: true,
        reflectToAttribute: true,
        observer: '_updateDistance'
      },

      /**
       * If true, the control will show arrows instead of numbers.
       */
      justArrows: {
        value: false,
        type: Boolean
      },

      /**
       * If true, shows the current page number. Only applicable if
       * justArrows is also true.
       */
      showCurrent: {
        value: false,
        type: Boolean
      },
      
      /**
       * When skipping large numbers of pages, this determines how
       * many pages to skip.
       */
      skipDistance: {
        value: 10,
        type: Number
      },
      
      /**
       * Include the total number of pages with current.  Only
       * applicable if showCurrent is also true.
       */
      showTotal: {
        value: false,
        type: Boolean
      }
    },

    observers: [
      '_updateNumbers(page, pages, distance)'
    ],

    ready: function() {
      this.numbers = [];
      for(var x = 1; x <= this.pages; x++) {
        this.push('numbers', this._buildNum(x));
      }
      this.page = this.page || 1;
      this.setAttribute('tabindex', 0);
    },

    _buildNum: function(num) {
      return {
        page: num,
        display: (this._isBuffer(num) ? '...' : num),
        classed: [
          (this._isBuffer(num) ? 'buffer' : ''),
          (num === this.page ? 'active' : '')
        ].join(''),
        buffer: this._isBuffer(num),
        active: num === this.page
      };
    },

    _isBuffer: function(num) {
      return !(
        num === 1
        ||
        num === this.pages
        ||
        Math.abs(this.page - num) <= this.distance
        ||
        (this.page - (this.distance+1) === 2 && num === 2)
        ||
        (this.page + (this.distance+1) === this.pages - 1 && num === this.pages - 1)
      );
    },

    _updatePages: function(newPages) {
      if(this.numbers === undefined) return;
      if(newPages > this.numbers.length) {
        for(var x = this.numbers.length+1; x <= newPages; x++) {
          this.push('numbers', this._buildNum(x));
        }
      } else {
        this.splice('numbers', newPages, this.numbers.length-newPages || 0);
      }
      if(this.page > newPages) {
        this.page = newPages;
      } else {
        this._updateNumbers();
      }
    },
    _updatePage: function(newPage, oldPage) {
      if(this.numbers === undefined) return;
      if(newPage < 1) this.page = 1;
      if(newPage > this.pages) this.page = this.pages;
      this._updateNumbers();
    },
    _updateDistance: function() {
      if(this.numbers === undefined) return;
      this._updateNumbers();
    },
    _updateNumbers: function() {
      if(this.numbers === undefined) return;
      for(var x = 1; x <= this.pages; x++) {
        this.set('numbers.'+(x-1)+'.display', this._isBuffer(x) ? '...' : x);
        this.set('numbers.'+(x-1)+'.classed', [
          (this._isBuffer(x) ? 'buffer' : ''),
          (this.page === x ? 'active' : '')
        ].join(''));
        this.set('numbers.'+(x-1)+'.active', this.page === x);
        this.set('numbers.'+(x-1)+'.buffer', this._isBuffer(x));
      }
    },

    _paged: function(event, detail, sender) {
      if(event) event.preventDefault();
      if(this.numbers === undefined) return;
      if(event.model.item.buffer) return;
      this.page = event.model.item.page;
      this.fire('vellum-page-changed', this.page);
    },

    _setFocus: function(event){
      this.focus();
    },

    /**
     * The `vellum-page-changed` event is fired whenever the page number is changed.
     *
     * @event vellum-page-changed
     * @detail pageNumber
     */

    /**
     * Set the current page.
     *
     * @param {number} Page to set.
     */
    go: function(num) {
      this.page = num;
      this.fire('vellum-page-changed', this.page);
    },

    /**
     * Go to the next page.
     */
    next: function() {
      this.page++;
      this.fire('vellum-page-changed', this.page);

      var nextButton = Polymer.dom(this.root).querySelector('#nextButton');
      if(nextButton) {
        nextButton.$.ink.simulatedRipple();
      }
    },

    /**
     * Go to the next Nth page, determined by `skipDistance`.
     */
    skipNext: function(){
      this.page += this.skipDistance;
      this.fire('vellum-page-changed', this.page);
    },

    /**
     * Go to the previous page.
     */
    prev: function() {
      this.page--;
      this.fire('vellum-page-changed', this.page);

      var prevButton = Polymer.dom(this.root).querySelector('#prevButton');
      if(prevButton) {
        prevButton.$.ink.simulatedRipple();
      }
    },

    /**
     * Go to the previous Nth page, determined by `skipDistance`.
     */
    skipPrev: function(){
      this.page -= this.skipDistance;
      this.fire('vellum-page-changed', this.page)
    },

    /**
     * Go to the first page.
     */
    first: function() {
      this.page = 1;
      this.fire('vellum-page-changed', this.page);

      var firstButton = Polymer.dom(this.root).querySelector('#firstButton');
      if(firstButton) {
        firstButton.$.ink.simulatedRipple();
      }
    },

    /**
     * Go to the last page.
     */
    last: function() {
      this.page = this.pages;
      this.fire('vellum-page-changed', this.page);

      var lastButton = Polymer.dom(this.root).querySelector('#lastButton');
      if(lastButton) {
        lastButton.$.ink.simulatedRipple();
      }
    },

  });

</script>
